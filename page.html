<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Viewer</title>
    <link rel="stylesheet" href="page.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.0/dist/mermaid.min.js" 
            onerror="console.warn('Failed to load Mermaid from CDN')"
            onload="console.log('Mermaid loaded from CDN')"></script>
    <script>
        // Initialize Mermaid when it loads
        window.mermaidReady = false;
        
        // More robust mermaid loading check
        function checkMermaidLoaded() {
            if (typeof mermaid !== 'undefined') {
                console.log('Mermaid is available');
                window.mermaidReady = true;
                return true;
            }
            return false;
        }
        
        // Initial check
        if (!checkMermaidLoaded()) {
            // Poll for mermaid availability
            let attempts = 0;
            const maxAttempts = 100;
            
            const pollMermaid = () => {
                attempts++;
                if (checkMermaidLoaded()) {
                    console.log('Mermaid loaded after', attempts, 'attempts');
                } else if (attempts < maxAttempts) {
                    setTimeout(pollMermaid, 100);
                } else {
                    console.warn('Mermaid failed to load after', maxAttempts, 'attempts');
                }
            };
            
            pollMermaid();
        }
    </script>
</head>
<body>
    <div class="toc-container" id="toc-container">
        <div class="toc-header">
            <h3>Table of Contents</h3>
            <button class="toc-toggle" onclick="toggleToc()">×</button>
        </div>
        <div class="toc-content" id="toc-content"></div>
    </div>

    <div class="search-container" id="search-container">
        <div class="search-header">
            <h3>Search</h3>
            <button class="search-toggle" onclick="toggleSearch()">×</button>
        </div>
        <div class="search-controls">
            <input type="text" id="search-input" placeholder="Enter search term..." oninput="performSearch()">
            <div class="search-options">
                <label><input type="checkbox" id="case-sensitive" onchange="performSearch()"> Case sensitive</label>
                <label><input type="checkbox" id="regex-search" onchange="performSearch()"> Regular expression</label>
            </div>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <div class="main-content">
        <div class="toolbar">
            <button class="tool-btn" onclick="toggleToc()" title="Toggle TOC">📋</button>
            <button class="tool-btn" onclick="toggleSearch()" title="Toggle Search">🔍</button>
            <button class="tool-btn" onclick="scrollToTop()" title="Scroll to Top">⬆️</button>
            <button class="tool-btn" onclick="printPage()" title="Print">🖨️</button>
        </div>

        <div class="content" id="content">
            <div class="loading">Loading markdown file...</div>
        </div>
    </div>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <script src="page.js"></script>
</body>
</html>